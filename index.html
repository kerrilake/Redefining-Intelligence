<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unspeciated: Redefining Intelligence - Research Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #ffffff 50%, #dcfce7 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 1.125rem;
            color: #4b5563;
            max-width: 768px;
            margin: 0 auto 16px auto;
            font-style: italic;
        }

        .tagline {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .ecosystem-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .ecosystem-btn {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4338ca;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .ecosystem-btn:hover {
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .ecosystem-btn.current {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 24px;
            margin-bottom: 32px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .species-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .enhancement-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 12px;
            border: 1px solid #bfdbfe;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .checkbox-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1f2937;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 8px;
            border: 1px solid #93c5fd;
            display: flex;
            align-items: center;
            gap: 8px;
            display: none;
        }

        .progress.show {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #bfdbfe;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-text {
            color: #1e40af;
            font-weight: 500;
        }

        .results {
            opacity: 0;
            animation: fadeIn 0.6s ease forwards;
            display: none;
        }

        .results.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wisdom-grid {
            display: grid;
            gap: 24px;
        }

        .completion-banner {
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-radius: 8px;
            border: 1px solid #86efac;
            text-align: center;
        }

        .completion-text {
            color: #166534;
            font-weight: 500;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 16px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .special-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .special-card {
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .physics-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left-color: #f59e0b;
        }

        .contribution-card {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left-color: #10b981;
        }

        .research-card {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border-left-color: #ec4899;
        }

        .special-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .special-content {
            color: #374151;
            line-height: 1.6;
        }

        .contribute-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .contribute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            display: none;
        }

        .firebase-status.show {
            display: block;
            animation: fadeInSlide 0.5s ease;
        }

        .firebase-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .title {
                font-size: 2rem;
            }

            .species-inputs {
                grid-template-columns: 1fr;
            }

            .enhancement-options {
                grid-template-columns: 1fr;
            }

            .ecosystem-nav {
                gap: 12px;
            }

            .ecosystem-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Firebase Status Indicator -->
        <div id="firebaseStatus" class="firebase-status">
            üîÑ Connecting to secure API...
        </div>

        <!-- Header -->
        <div class="header">
            <h1 class="title">üß† Unspeciated: Research Explorer</h1>
            <p class="subtitle">Discovering Intelligence Through the Perceive ‚Ä¢ Relate ‚Ä¢ Apply Framework</p>
            <p class="tagline">Exploring intelligence across all life forms with wonder and wisdom</p>
        </div>

        <!-- Ecosystem Navigation -->
        <div class="ecosystem-nav">
            <a href="https://integratedintelligencemap.netlify.app" target="_blank" class="ecosystem-btn">
                üå∏ Intelligence Map
            </a>
            <a href="https://ai-consciousness-bridge.netlify.app" target="_blank" class="ecosystem-btn">
                ü§ñ AI Bridge
            </a>
            <span class="ecosystem-btn current">
                üìö Research Explorer (Current)
            </span>
        </div>

        <!-- Input Form -->
        <div class="card">
            <h2 class="card-title">Explore Relational Intelligence</h2>
            
            <div class="species-inputs">
                <div class="input-group">
                    <label class="label">First Life Form:</label>
                    <input type="text" id="species1" class="input" placeholder="e.g., dolphins, trees, bees">
                </div>
                <div class="input-group">
                    <label class="label">Second Life Form:</label>
                    <input type="text" id="species2" class="input" placeholder="e.g., mycorrhizal networks, octopuses">
                </div>
                <div class="input-group">
                    <label class="label">Third Life Form (Optional):</label>
                    <input type="text" id="species3" class="input" placeholder="e.g., coral reefs, crystalline structures">
                </div>
            </div>

            <div class="enhancement-options">
                <div class="checkbox-group">
                    <input type="checkbox" id="indigenous" class="checkbox" checked>
                    <label for="indigenous" class="checkbox-label">Include Indigenous Wisdom</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="biomimicry" class="checkbox" checked>
                    <label for="biomimicry" class="checkbox-label">Include Biomimicry Insights</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="human" class="checkbox">
                    <label for="human" class="checkbox-label">Include Human Life-Form</label>
                </div>
            </div>

            <button onclick="exploreIntelligence()" id="exploreBtn" class="btn">
                üîç Explore Relational Intelligence
            </button>
            
            <div style="margin-top: 16px;">
                <button onclick="openContributeForm()" class="contribute-btn">
                    ‚ú® Contribute Knowledge
                </button>
            </div>

            <div id="progressDiv" class="progress">
                <div class="spinner"></div>
                <p class="progress-text" id="progressText">Connecting to multi-disciplinary research networks...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results">
            <div class="completion-banner">
                <p class="completion-text" id="completionTime">‚úÖ Intelligence exploration completed</p>
                <button onclick="generatePDF()" class="export-btn">üìÑ Break It Down For Me (download pdf report)</button>
            </div>

            <!-- Species Wisdom -->
            <div class="card">
                <h2 class="card-title">üí´ Species Wisdom Insights</h2>
                <div id="wisdomContent" class="wisdom-grid">
                    <!-- Wisdom cards will be inserted here -->
                </div>
            </div>

            <!-- Special Insights -->
            <div class="special-sections" id="specialSections">
                <!-- Special insight cards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="margin-top: 80px; padding: 40px 0; text-align: center; border-top: 1px solid rgba(209, 213, 219, 0.3); background: rgba(255, 255, 255, 0.5);">
        <div style="max-width: 600px; margin: 0 auto;">
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">
                <strong>Unspeciated: Redefining Intelligence</strong>
            </p>
            <p style="color: #9ca3af; font-size: 13px; line-height: 1.5; margin-bottom: 16px;">
                Exploring consciousness and relational intelligence across all life forms through the Perceive ‚Ä¢ Relate ‚Ä¢ Apply framework
            </p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 16px; flex-wrap: wrap;">
                <a href="https://intuitivelearningfoundation.org" target="_blank" style="color: #6366f1; text-decoration: none; font-size: 13px; transition: color 0.3s ease;">
                    Intuitive Learning Foundation
                </a>
                <a href="https://generateharmony.com" target="_blank" style="color: #6366f1; text-decoration: none; font-size: 13px; transition: color 0.3s ease;">
                    Generate Harmony
                </a>
                <a href="https://kerrilake.com" target="_blank" style="color: #6366f1; text-decoration: none; font-size: 13px; transition: color 0.3s ease;">
                    Kerri Lake
                </a>
            </div>
            <p style="color: #9ca3af; font-size: 12px; margin: 0;">
                ¬© 2025 Kerri Lake. Framework for redefining intelligence beyond human-centric definitions.
            </p>
        </div>
    </footer>

    <script>
        // FIXED: Your secure Firebase Function URLs - exact same as working version
        const FIREBASE_SPECIES_API = 'https://getspeciesintelligence-pyu4dtffdq-ue.a.run.app';
        const FIREBASE_HEALTH_API = 'https://healthcheck-pyu4dtffdq-ue.a.run.app';

        let researchResults = null;
        let isResearching = false; // Add state management to prevent multiple calls

        // FIXED: Test Firebase connection with better error handling
        async function testFirebaseConnection() {
            const statusEl = document.getElementById('firebaseStatus');
            try {
                console.log('Testing Firebase connection...');
                const response = await fetch(FIREBASE_HEALTH_API);
                console.log('Health check response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Health check data:', data);
                    statusEl.innerHTML = '‚úÖ Connected to Secure API';
                    statusEl.classList.add('show');
                    setTimeout(() => statusEl.classList.remove('show'), 3000);
                } else {
                    throw new Error(`Health check failed with status: ${response.status}`);
                }
            } catch (error) {
                console.error('Firebase connection error:', error);
                statusEl.innerHTML = '‚ùå API Connection Error';
                statusEl.classList.add('show', 'error');
                // Keep error visible longer
                setTimeout(() => statusEl.classList.remove('show'), 5000);
            }
        }

        // Test connection on page load
        testFirebaseConnection();

        // FIXED: Main exploration function with better state management
        window.exploreIntelligence = async function() {
            const btn = document.getElementById('exploreBtn');
            const progressDiv = document.getElementById('progressDiv');
            const progressText = document.getElementById('progressText');
            const resultsSection = document.getElementById('resultsSection');

            // Prevent multiple simultaneous research sessions
            if (isResearching) {
                console.log('Research already in progress, ignoring duplicate call');
                return;
            }

            // Validation
            const species1 = document.getElementById('species1').value.trim();
            const species2 = document.getElementById('species2').value.trim();
            
            if (!species1 || !species2) {
                alert('Please enter at least two life forms to explore their spectrum of intelligence.');
                return;
            }

            // Set research state
            isResearching = true;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Exploring...Please allow 1 to 2 minutes for synthesis';
            progressDiv.classList.add('show');
            resultsSection.classList.remove('show');

            const species3 = document.getElementById('species3').value.trim();
            const includeIndigenous = document.getElementById('indigenous').checked;
            const includeBiomimicry = document.getElementById('biomimicry').checked;
            const includeHuman = document.getElementById('human').checked;

            try {
                console.log('Starting intelligence exploration...');
                
                // Get species data using secure Firebase functions
                progressText.textContent = 'Illuminating species intelligence...';
                
                const speciesQueries = [species1, species2];
                if (species3) speciesQueries.push(species3);
                if (includeHuman) speciesQueries.push('humans');

                console.log('Fetching data for species:', speciesQueries);

                const speciesData = await Promise.all([
                    getSecureSpeciesData(species1, { includeIndigenous, includeBiomimicry, includeHuman }),
                    getSecureSpeciesData(species2, { includeIndigenous, includeBiomimicry, includeHuman }),
                    species3 ? getSecureSpeciesData(species3, { includeIndigenous, includeBiomimicry, includeHuman }) : null,
                    includeHuman ? getSecureSpeciesData('humans', { includeIndigenous, includeBiomimicry, includeHuman }) : null
                ].filter(Boolean));

                console.log('Species data retrieved:', speciesData.length, 'species');

                // Generate special sections
                progressText.textContent = 'Creating unified insights...';
                const specialSections = generateEnhancedSpecialSections(speciesData);

                // Store results (without relationships)
                researchResults = {
                    species: speciesData,
                    special: specialSections,
                    timestamp: new Date().toLocaleString(),
                    options: { includeIndigenous, includeBiomimicry, includeHuman }
                };

                console.log('Research completed successfully');

                // Display results
                displayResults();

            } catch (error) {
                console.error('Exploration error:', error);
                progressText.textContent = `Exploration encountered an issue: ${error.message}. Please try again.`;
                setTimeout(() => {
                    progressDiv.classList.remove('show');
                }, 3000);
            } finally {
                // Always reset state
                isResearching = false;
                btn.disabled = false;
                btn.innerHTML = 'üîç Explore Relational Intelligence';
                progressDiv.classList.remove('show');
                if (researchResults) {
                    resultsSection.classList.add('show');
                }
            }
        };

        // FIXED: Improved species data fetching with better error handling
        async function getSecureSpeciesData(speciesName, options) {
            try {
                console.log(`Fetching data for: ${speciesName}`);
                
                const response = await fetch(FIREBASE_SPECIES_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ species: speciesName })
                });

                console.log(`Response for ${speciesName} - Status: ${response.status}, OK: ${response.ok}`);

                if (!response.ok) {
                    // Try to get the error message from the response
                    let errorMessage = `API Error: ${response.status}`;
                    try {
                        const errorData = await response.text();
                        console.log(`Error response for ${speciesName}:`, errorData);
                        if (errorData) {
                            errorMessage += ` - ${errorData}`;
                        }
                    } catch (e) {
                        console.log('Could not parse error response');
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log(`Data received for ${speciesName}:`, data);
                
               // Use the new JSON parser to handle both old and new formats
return parseFirebaseResponse(data);

            } catch (error) {
                console.error(`Error getting data for ${speciesName}:`, error);
                throw error;
            }
        }

        function generateEnhancedSpecialSections(speciesData) {
            const speciesNames = speciesData.map(s => s.name);
            
            return {
                unified_physics: generateUnifiedPhysicsInsight(speciesData, speciesNames),
                contribution_to_life: generateLifeContributionInsight(speciesData, speciesNames),
                research_frontiers: generateResearchFrontiers(speciesData, speciesNames)
            };
        }

        function generateUnifiedPhysicsInsight(speciesData, names) {
            // Extract quantum and electromagnetic patterns from actual species data
            const quantumElements = [];
            const coherencePatterns = [];
            
            speciesData.forEach(species => {
                if (species.quantumBiology || (species.energetic && species.energetic.includes('electromagnetic'))) {
                    quantumElements.push(species.name);
                }
                if (species.collective && (species.collective.includes('synchronize') || species.collective.includes('coherence'))) {
                    coherencePatterns.push(species.name);
                }
            });
            
            if (quantumElements.length > 1) {
                return `What we're witnessing across ${names.join(', ')} is evidence of quantum coherence operating at biological scales - each species demonstrating that consciousness and matter are fundamentally entangled. Their intelligence emerges from quantum field interactions that transcend our classical understanding of space and time, suggesting that awareness itself is a fundamental property woven into the fabric of reality.`;
            }
            
            return `These species reveal that intelligence operates through quantum field dynamics where information, energy, and consciousness are unified. Rather than separate minds processing isolated data, we see interconnected awareness participating in what appears to be a planetary-scale quantum system where each species contributes unique frequencies to an emerging collective intelligence.`;
        }

        function generateLifeContributionInsight(speciesData, names) {
            // Focus on symbiosis, interconnection, and planetary harmony
            const contributions = [];
            
            speciesData.forEach(species => {
                if (species.apply && species.apply.includes('ecosystem')) {
                    contributions.push(`${species.name} weave ecological balance`);
                } else if (species.relate && species.relate.includes('network')) {
                    contributions.push(`${species.name} create communication webs`);
                } else if (species.energetic && species.energetic.includes('healing')) {
                    contributions.push(`${species.name} generate healing fields`);
                } else if (species.collective && species.collective.includes('collective')) {
                    contributions.push(`${species.name} demonstrate collective wisdom`);
                } else {
                    contributions.push(`${species.name} offer unique gifts of awareness`);
                }
            });
            
            return `Here's the beautiful truth emerging from ${names.join(' and ')}: ${contributions.join(', ')}, creating a living symphony where every species contributes essential notes to planetary wellbeing. They're showing us that Earth's intelligence isn't a hierarchy with humans at the top, but a collaborative masterpiece where each form of life enhances the resilience and consciousness of the whole. We're not separate from this web - we're participants whose role is to recognize and honor the wisdom flowing through all life.`;
        }

        function generateResearchFrontiers(speciesData, names) {
            // Generate 3-4 research directions that re-include humans in the family of life
            const frontiers = [];
            
            // Technology for interspecies communication
            if (speciesData.some(s => s.relate && (s.relate.includes('communication') || s.relate.includes('acoustic') || s.relate.includes('electromagnetic')))) {
                frontiers.push('**Interspecies Communication Technologies**: Developing AI systems that can translate between human and non-human intelligence patterns, creating bridges for genuine cross-species dialogue');
            }
            
            // Quantum biology applications
            if (speciesData.some(s => s.quantumBiology || (s.energetic && s.energetic.includes('electromagnetic')))) {
                frontiers.push('**Quantum Biology Applications**: Investigating how natural quantum coherence systems could inform human healing technologies and consciousness expansion practices');
            }
            
            // Ecosystem intelligence studies
            if (speciesData.some(s => s.collective || (s.apply && s.apply.includes('ecosystem')))) {
                frontiers.push('**Ecosystem Intelligence Networks**: Mapping how different species coordinate information flows to maintain planetary balance, revealing human roles within these larger systems');
            }
            
            // Legal and educational frameworks
            frontiers.push('**Consciousness-Based Ethics**: Developing legal frameworks and educational curricula that recognize non-human intelligence as inherently valuable, not just instrumentally useful to humans');
            
            // Limit to 4 items and create final insight
            const selectedFrontiers = frontiers.slice(0, 4);
            
            return `The convergence of ${names.join(', ')} research opens pathways for humanity to remember our place in the family of life: ${selectedFrontiers.join('; ')}. These directions don't just advance scientific knowledge - they invite us back into conscious participation with the profound intelligence that has been surrounding us all along.`;
        }

        // SURGICAL FIX: This only fixes JSON truncation - preserves ALL your content exactly as-is
        function parseFirebaseResponse(data) {
            try {
                const intelligence = data.intelligence;
                console.log('Raw intelligence data:', intelligence.substring(0, 200) + '...'); // Debug preview
                
                // Try to parse as JSON first (new format)
                let parsedData;
                try {
                    // Check if JSON is complete by counting braces
                    const openBraces = (intelligence.match(/\{/g) || []).length;
                    const closeBraces = (intelligence.match(/\}/g) || []).length;
                    
                    if (openBraces !== closeBraces) {
                        console.warn('Truncated JSON detected - repairing structure while preserving content...');
                        
                        // SURGICAL REPAIR: Only fix structure, never change your words
                        let repairedJSON = intelligence;
                        
                        // If it ends mid-sentence, try to close it properly
                        if (!intelligence.trim().endsWith('}')) {
                            // Count quote pairs to see if we're inside a string
                            const quotes = (intelligence.match(/"/g) || []).length;
                            if (quotes % 2 === 1) {
                                // Odd number of quotes means we're inside a string - close it
                                repairedJSON += '"';
                            }
                            // Close any open objects (structure only, no content changes)
                            const openObjects = openBraces - closeBraces;
                            for (let i = 0; i < openObjects; i++) {
                                repairedJSON += '}';
                            }
                        }
                        
                        console.log('JSON structure repaired - parsing your content...');
                        parsedData = JSON.parse(repairedJSON);
                    } else {
                        parsedData = JSON.parse(intelligence);
                    }
                    
                    console.log('Successfully extracted your content:', parsedData.keyWisdom?.substring(0, 100) + '...');
                    
                    // PURE EXTRACTION: Move your beautiful content to display fields (NO modifications)
                    return {
                        name: data.species,
                        
                        // Your inspiring "What if I told you..." content goes here exactly as-is:
                        essence: parsedData.keyWisdom || "This species demonstrates remarkable intelligence.",
                        
                        // Your rich perceive content ("You know how we see colors? Well..."):
                        perceive_wisdom: parsedData.perceive?.summary || "Advanced perceptual capabilities",
                        perceive_details: parsedData.perceive?.details || ["Sophisticated sensory systems"],
                        
                        // Your engaging relate content ("Imagine if you could have entire conversations..."):
                        relate_wisdom: parsedData.relate?.summary || "Complex relational intelligence", 
                        relate_details: parsedData.relate?.details || ["Advanced communication"],
                        
                        // Your wonder-filled apply content ("Here's where it gets incredible..."):
                        apply_wisdom: parsedData.apply?.summary || "Strategic problem-solving abilities",
                        apply_details: parsedData.apply?.details || ["Adaptive behaviors"],
                        
                        // Enhanced dimensions - your content preserved exactly:
                        temporal: parsedData.temporal || null,           // "Time works differently..."
                        energetic: parsedData.energetic || null,         // "Scientists are discovering..."
                        collective: parsedData.collective || null,       // "When they come together..."
                        adaptive: parsedData.adaptive || null,           // Your adaptive insights
                        quantumBiology: parsedData.quantumBiology || null,   // Your quantum content
                        humanLearning: parsedData.humanLearning || null,     // Your learning insights
                        conservation: parsedData.conservation || null,       // Your conservation wisdom
                        sources: parsedData.sources || [],
                        
                        cached: data.cached || false,
                        timestamp: data.timestamp
                    };
                    
                } catch (parseError) {
                    console.error('JSON parsing failed, trying text extraction to preserve your content:', parseError);
                    
                    // BACKUP EXTRACTION: Get your content even from truncated text
                    const extractYourContent = (text, fieldName) => {
            // For nested objects like "perceive": { "summary": "content" }
            let regex = new RegExp(`"${fieldName}":\\s*{[^}]*"summary":\\s*"([^"]+)"`, 'i');
            let match = text.match(regex);
            if (match) return match[1];
            
            // For direct fields like "keyWisdom": "content"
            regex = new RegExp(`"${fieldName}":\\s*"([^"]+)"`, 'i');
            match = text.match(regex);
            return match ? match[1] : null;
        };
                    
                    const extractYourArray = (text, fieldName) => {
                        const regex = new RegExp(`"${fieldName}":\\s*\\[([^\\]]*)]`, 'i');
                        const match = text.match(regex);
                        if (match) {
                            try {
                                return JSON.parse(`[${match[1]}]`);
                            } catch {
                                return match[1].split(',').map(item => item.replace(/"/g, '').trim()).filter(item => item);
                            }
                        }
                        return [];
                    };
                    
                    // Extract your beautiful content even from broken JSON:
                    return {
                        name: data.species,
                        essence: extractYourContent(intelligence, 'keyWisdom') || `${data.species} demonstrate remarkable intelligence patterns.`,
                        perceive_wisdom: extractYourContent(intelligence, 'perceive') || "Advanced perceptual capabilities",
                        perceive_details: extractYourArray(intelligence, 'details') || ["Sophisticated sensory systems"],
                        relate_wisdom: extractYourContent(intelligence, 'relate') || "Complex relational intelligence", 
                        relate_details: ["Advanced communication patterns"],
                        apply_wisdom: extractYourContent(intelligence, 'apply') || "Strategic problem-solving abilities",
                        apply_details: ["Adaptive behaviors"],
                        
                        // Preserve enhanced dimensions from partial text:
                        temporal: extractYourContent(intelligence, 'temporal'),
                        energetic: extractYourContent(intelligence, 'energetic'), 
                        collective: extractYourContent(intelligence, 'collective'),
                        adaptive: extractYourContent(intelligence, 'adaptive'),
                        quantumBiology: extractYourContent(intelligence, 'quantumBiology'),
                        humanLearning: extractYourContent(intelligence, 'humanLearning'),
                        conservation: extractYourContent(intelligence, 'conservation'),
                        sources: extractYourArray(intelligence, 'sources'),
                        
                        cached: data.cached || false,
                        timestamp: data.timestamp
                    };
                }
            } catch (error) {
                console.error('Complete parsing failure - using minimal fallback:', error);
                
                // MINIMAL FALLBACK: Only used in complete failure
                return {
                    name: data.species || "Unknown Species",
                    essence: "Intelligence analysis in progress...",
                    perceive_wisdom: "Perceptual capabilities",
                    perceive_details: ["Sensory awareness"],
                    relate_wisdom: "Relational intelligence", 
                    relate_details: ["Communication abilities"],
                    apply_wisdom: "Applied intelligence",
                    apply_details: ["Problem-solving skills"],
                    cached: false,
                    timestamp: new Date().toISOString()
                };
            }
        }
                
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const wisdomContent = document.getElementById('wisdomContent');
            const specialSections = document.getElementById('specialSections');
            const completionTime = document.getElementById('completionTime');

            // Update completion time
            completionTime.textContent = `‚úÖ Intelligence exploration completed: ${researchResults.timestamp}`;

            // COMPLETE SPECIES DISPLAY - All 11 Dimensions
            let wisdomHTML = '';
            researchResults.species.forEach((species, index) => {
                const icons = ['üê¨', 'üå≥', 'ü¶ã', 'üåä', 'üß†', 'ü¶Ö', 'üêù', 'üå∏'];
                const cachedIndicator = species.cached ? 
                    '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">üìö Cached</span>' : 
                    '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">‚ú® New</span>';
                
                wisdomHTML += `
                    <div style="margin-bottom: 48px;">
                        <h3 style="font-size: 1.8rem; font-weight: 600; color: #1f2937; margin-bottom: 24px; text-align: center;">
                            ${icons[index]} ${species.name} ${cachedIndicator}
                        </h3>
                        
                        <!-- Key Discovery Card -->
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 12px; padding: 24px; margin-bottom: 20px; border-left: 4px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
                            <h4 style="font-size: 1.2rem; font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                üí° Key Discovery
                            </h4>
                            <p style="color: #451a03; line-height: 1.7; font-size: 1.05rem; font-style: italic;">
                                ${species.essence}
                            </p>
                        </div>
                        
                        <!-- Core Intelligence Framework (Perceive/Relate/Apply) -->
                        <h4 style="font-size: 1.1rem; font-weight: 600; color: #374151; margin: 20px 0 12px 0; text-align: center;">
                            üß† Core Intelligence Framework
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            
                            <!-- Perceive Card -->
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #3b82f6; border-radius: 12px; padding: 20px; border-left: 4px solid #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);">
                                <h4 style="font-size: 1rem; font-weight: 600; color: #1e40af; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    üëÅ Perceive
                                </h4>
                                <p style="color: #1e3a8a; line-height: 1.6; margin-bottom: 12px; font-size: 0.95rem;">
                                    ${species.perceive_wisdom}
                                </p>
                                <ul style="color: #1e3a8a; margin-left: 16px; line-height: 1.5; font-size: 0.9rem;">
                                    ${species.perceive_details.map(detail => `<li style="margin-bottom: 4px;">${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <!-- Relate Card -->
                            <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 1px solid #10b981; border-radius: 12px; padding: 20px; border-left: 4px solid #10b981; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);">
                                <h4 style="font-size: 1rem; font-weight: 600; color: #047857; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    üíö Relate
                                </h4>
                                <p style="color: #064e3b; line-height: 1.6; margin-bottom: 12px; font-size: 0.95rem;">
                                    ${species.relate_wisdom}
                                </p>
                                <ul style="color: #064e3b; margin-left: 16px; line-height: 1.5; font-size: 0.9rem;">
                                    ${species.relate_details.map(detail => `<li style="margin-bottom: 4px;">${detail}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <!-- Apply Card -->
                            <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 1px solid #8b5cf6; border-radius: 12px; padding: 20px; border-left: 4px solid #8b5cf6; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);">
                                <h4 style="font-size: 1rem; font-weight: 600; color: #6b21a8; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ‚ú® Apply
                                </h4>
                                <p style="color: #581c87; line-height: 1.6; margin-bottom: 12px; font-size: 0.95rem;">
                                    ${species.apply_wisdom}
                                </p>
                                <ul style="color: #581c87; margin-left: 16px; line-height: 1.5; font-size: 0.9rem;">
                                    ${species.apply_details.map(detail => `<li style="margin-bottom: 4px;">${detail}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Enhanced Intelligence Dimensions -->
                        <h4 style="font-size: 1.1rem; font-weight: 600; color: #374151; margin: 24px 0 12px 0; text-align: center;">
                            üåü Enhanced Intelligence Dimensions
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; margin-bottom: 20px;">
                            
                            ${species.temporal ? `
                            <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border: 1px solid #ec4899; border-radius: 10px; padding: 16px; border-left: 4px solid #ec4899;">
                                <h5 style="font-size: 0.95rem; font-weight: 600; color: #be185d; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    ‚è∞ Temporal Intelligence
                                </h5>
                                <p style="color: #831843; line-height: 1.5; font-size: 0.9rem;">${species.temporal}</p>
                            </div>
                            ` : ''}
                            
                            ${species.energetic ? `
                            <div style="background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%); border: 1px solid #0284c7; border-radius: 10px; padding: 16px; border-left: 4px solid #0284c7;">
                                <h5 style="font-size: 0.95rem; font-weight: 600; color: #0369a1; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    ‚ö° Energetic Intelligence
                                </h5>
                                <p style="color: #075985; line-height: 1.5; font-size: 0.9rem;">${species.energetic}</p>
                            </div>
                            ` : ''}
                            
                            ${species.collective ? `
                            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #22c55e; border-radius: 10px; padding: 16px; border-left: 4px solid #22c55e;">
                                <h5 style="font-size: 0.95rem; font-weight: 600; color: #15803d; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    ü§ù Collective Intelligence
                                </h5>
                                <p style="color: #166534; line-height: 1.5; font-size: 0.9rem;">${species.collective}</p>
                            </div>
                            ` : ''}
                            
                            ${species.adaptive ? `
                            <div style="background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%); border: 1px solid #ea580c; border-radius: 10px; padding: 16px; border-left: 4px solid #ea580c;">
                                <h5 style="font-size: 0.95rem; font-weight: 600; color: #c2410c; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    üîÑ Adaptive Intelligence
                                </h5>
                                <p style="color: #9a3412; line-height: 1.5; font-size: 0.9rem;">${species.adaptive}</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Advanced Research Dimensions -->
                        <h4 style="font-size: 1.1rem; font-weight: 600; color: #374151; margin: 24px 0 12px 0; text-align: center;">
                            üî¨ Advanced Research Dimensions
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            
                            ${species.quantumBiology ? `
                            <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 1px solid #a855f7; border-radius: 12px; padding: 18px; border-left: 4px solid #a855f7; box-shadow: 0 2px 8px rgba(168, 85, 247, 0.1);">
                                <h5 style="font-size: 1rem; font-weight: 600; color: #7c3aed; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                    üåå Quantum Biology
                                </h5>
                                <p style="color: #5b21b6; line-height: 1.6; font-size: 0.95rem;">${species.quantumBiology}</p>
                            </div>
                            ` : ''}
                            
                            ${species.humanLearning ? `
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #d97706; border-radius: 12px; padding: 18px; border-left: 4px solid #d97706; box-shadow: 0 2px 8px rgba(217, 119, 6, 0.1);">
                                <h5 style="font-size: 1rem; font-weight: 600; color: #b45309; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                    üéì Human Learning Opportunities
                                </h5>
                                <p style="color: #92400e; line-height: 1.6; font-size: 0.95rem;">${species.humanLearning}</p>
                            </div>
                            ` : ''}
                            
                            ${species.conservation ? `
                            <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #059669; border-radius: 12px; padding: 18px; border-left: 4px solid #059669; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);">
                                <h5 style="font-size: 1rem; font-weight: 600; color: #047857; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                    üåç Conservation Insights
                                </h5>
                                <p style="color: #065f46; line-height: 1.6; font-size: 0.95rem;">${species.conservation}</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Research Sources -->
                        ${species.sources && species.sources.length > 0 ? `
                        <div style="margin-top: 20px; padding: 16px; background: rgba(243, 244, 246, 0.7); border-radius: 10px; border-left: 3px solid #6b7280;">
                            <h5 style="font-size: 0.95rem; font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                üìö Research Sources
                            </h5>
                            <ul style="color: #4b5563; font-size: 0.85rem; margin-left: 16px; line-height: 1.4;">
                                ${species.sources.map(source => `<li style="margin-bottom: 3px;">${source}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            wisdomContent.innerHTML = wisdomHTML;

            // Display special sections
            if (researchResults.special) {
                specialSections.innerHTML = `
                    <div class="special-card physics-card">
                        <h3 class="special-title">‚ö° Unified Physics Integration</h3>
                        <div class="special-content">${researchResults.special.unified_physics}</div>
                    </div>
                    <div class="special-card contribution-card">
                        <h3 class="special-title">üå± Contribution to Life</h3>
                        <div class="special-content">${researchResults.special.contribution_to_life}</div>
                    </div>
                    <div class="special-card research-card">
                        <h3 class="special-title">üî¨ Research Frontiers</h3>
                        <div class="special-content">${researchResults.special.research_frontiers}</div>
                    </div>
                `;
            }

            // Show results
            resultsSection.classList.add('show');
        }

        // COMPREHENSIVE PDF generation function - includes ALL intelligence dimensions
        // COMPREHENSIVE PDF generation function - opens print dialog for true PDF download
        window.generatePDF = function() {
            if (!researchResults) {
                alert('No research data available to export.');
                return;
            }

            const speciesNames = researchResults.species.map(s => s.name).join('_');
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Unspeciated: Redefining Intelligence Search - ${speciesNames}</title>
    <style>
        body { 
            font-family: 'Georgia', 'Times New Roman', serif; 
            line-height: 1.6; 
            margin: 20px; 
            color: #333; 
            max-width: none;
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
            border-bottom: 3px solid #333; 
            padding-bottom: 25px; 
        }
        .title { 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 8px; 
            color: #000;
        }
        .subtitle { 
            font-size: 18px; 
            margin-bottom: 8px; 
            font-style: italic; 
            color: #555;
        }
        .meta { 
            font-size: 14px; 
            color: #666; 
            margin-bottom: 4px;
        }
        .section { 
            margin: 30px 0; 
            page-break-inside: avoid; 
        }
        .section-title { 
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #000; 
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .species-header {
            font-size: 22px;
            font-weight: bold;
            margin: 35px 0 20px 0;
            color: #000;
            text-align: center;
            border: 2px solid #333;
            padding: 15px;
            background: #f9f9f9;
        }
        .key-discovery {
            background: #fef9e7;
            border: 1px solid #d4a574;
            border-left: 4px solid #d4a574;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .key-discovery h4 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #8b5a2b;
        }
        .key-discovery p {
            font-style: italic;
            color: #5d4037;
            font-size: 15px;
        }
        .framework-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }
        .framework-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 18px;
            page-break-inside: avoid;
        }
        .framework-card h4 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .perceive-card { border-left: 4px solid #2563eb; background: #f8fafc; }
        .relate-card { border-left: 4px solid #059669; background: #f0fdf4; }
        .apply-card { border-left: 4px solid #7c3aed; background: #faf5ff; }
        .perceive-card h4 { color: #1e40af; }
        .relate-card h4 { color: #065f46; }
        .apply-card h4 { color: #5b21b6; }
        .dimensions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        .dimension-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            page-break-inside: avoid;
        }
        .dimension-card h5 {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .dimension-card p {
            font-size: 13px;
            line-height: 1.5;
        }
        .temporal { border-left: 4px solid #ec4899; background: #fdf2f8; }
        .temporal h5 { color: #be185d; }
        .energetic { border-left: 4px solid #0284c7; background: #f0f9ff; }
        .energetic h5 { color: #0369a1; }
        .collective { border-left: 4px solid #22c55e; background: #f0fdf4; }
        .collective h5 { color: #15803d; }
        .adaptive { border-left: 4px solid #ea580c; background: #fff7ed; }
        .adaptive h5 { color: #c2410c; }
        .advanced-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 25px 0;
        }
        .advanced-card {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 20px;
            page-break-inside: avoid;
        }
        .quantum { border-left: 4px solid #a855f7; background: #faf5ff; }
        .quantum h5 { color: #7c3aed; }
        .learning { border-left: 4px solid #d97706; background: #fef3c7; }
        .learning h5 { color: #b45309; }
        .conservation { border-left: 4px solid #059669; background: #ecfdf5; }
        .conservation h5 { color: #047857; }
        .advanced-card h5 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .sources {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .sources h5 {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #374151;
        }
        .sources ul {
            margin-left: 20px;
            font-size: 12px;
            line-height: 1.4;
        }
        .sources li {
            margin-bottom: 5px;
        }
        .special-sections {
            margin-top: 40px;
            border-top: 2px solid #333;
            padding-top: 30px;
        }
        .special-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            page-break-inside: avoid;
        }
        .special-card h3 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #000;
        }
        .footer { 
            margin-top: 50px; 
            text-align: center; 
            font-size: 11px; 
            border-top: 1px solid #333; 
            padding-top: 20px; 
            color: #666;
        }
        @media print { 
            body { margin: 15px; }
            .no-print { display: none !important; }
        }
        @page { margin: 0.75in; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Unspeciated: Redefining Intelligence</div>
        <div class="subtitle">Research Explorer ‚Ä¢ Perceive ‚Ä¢ Relate ‚Ä¢ Apply Framework</div>
        <div class="meta">Species Explored: ${researchResults.species.map(s => s.name).join(', ')}</div>
        <div class="meta">Generated: ${currentDate}</div>
        <div class="meta">Platform: Secure Firebase Functions ‚Ä¢ Intuitive Learning Foundation</div>
    </div>

    <div class="section">
        <div class="section-title">Executive Summary</div>
        <p>This intelligence exploration reveals the profound relational intelligence of ${researchResults.species.length} life form${researchResults.species.length > 1 ? 's' : ''} through the Perceive ‚Ä¢ Relate ‚Ä¢ Apply framework. Each species demonstrates unique intelligence patterns that expand our understanding of consciousness as a universal phenomenon extending far beyond human cognition. This research challenges anthropocentric definitions of intelligence and invites recognition of the collaborative intelligence matrix that connects all life on Earth.</p>
    </div>`;

            // Add comprehensive species sections
            researchResults.species.forEach((species, index) => {
                htmlContent += `
    <div class="species-header">
        ${species.name} Intelligence Profile ${species.cached ? '(From Database)' : '(Newly Generated)'}
    </div>

    <div class="key-discovery">
        <h4>üí° Key Discovery</h4>
        <p>${species.essence}</p>
    </div>

    <div class="section">
        <div class="section-title">Core Intelligence Framework</div>
        <div class="framework-container">
            <div class="framework-card perceive-card">
                <h4>üëÅ Perceive</h4>
                <p><strong>How they sense reality:</strong></p>
                <p>${species.perceive_wisdom}</p>
                ${species.perceive_details && species.perceive_details.length > 0 ? `
                <ul style="margin-top: 10px; font-size: 13px;">
                    ${species.perceive_details.map(detail => `<li>${detail}</li>`).join('')}
                </ul>` : ''}
            </div>
            <div class="framework-card relate-card">
                <h4>üíö Relate</h4>
                <p><strong>How they relate to what they sense:</strong></p>
                <p>${species.relate_wisdom}</p>
                ${species.relate_details && species.relate_details.length > 0 ? `
                <ul style="margin-top: 10px; font-size: 13px;">
                    ${species.relate_details.map(detail => `<li>${detail}</li>`).join('')}
                </ul>` : ''}
            </div>
            <div class="framework-card apply-card">
                <h4>‚ú® Apply</h4>
                <p><strong>How they act with intelligence:</strong></p>
                <p>${species.apply_wisdom}</p>
                ${species.apply_details && species.apply_details.length > 0 ? `
                <ul style="margin-top: 10px; font-size: 13px;">
                    ${species.apply_details.map(detail => `<li>${detail}</li>`).join('')}
                </ul>` : ''}
            </div>
        </div>
    </div>

    ${(species.temporal || species.energetic || species.collective || species.adaptive) ? `
    <div class="section">
        <div class="section-title">Enhanced Intelligence Dimensions</div>
        <div class="dimensions-grid">
            ${species.temporal ? `
            <div class="dimension-card temporal">
                <h5>‚è∞ Temporal Intelligence</h5>
                <p>${species.temporal}</p>
            </div>` : ''}
            ${species.energetic ? `
            <div class="dimension-card energetic">
                <h5>‚ö° Energetic Intelligence</h5>
                <p>${species.energetic}</p>
            </div>` : ''}
            ${species.collective ? `
            <div class="dimension-card collective">
                <h5>ü§ù Collective Intelligence</h5>
                <p>${species.collective}</p>
            </div>` : ''}
            ${species.adaptive ? `
            <div class="dimension-card adaptive">
                <h5>üîÑ Adaptive Intelligence</h5>
                <p>${species.adaptive}</p>
            </div>` : ''}
        </div>
    </div>` : ''}

    ${(species.quantumBiology || species.humanLearning || species.conservation) ? `
    <div class="section">
        <div class="section-title">Advanced Research Dimensions</div>
        <div class="advanced-grid">
            ${species.quantumBiology ? `
            <div class="advanced-card quantum">
                <h5>üåå Quantum Biology</h5>
                <p>${species.quantumBiology}</p>
            </div>` : ''}
            ${species.humanLearning ? `
            <div class="advanced-card learning">
                <h5>üéì Human Learning Opportunities</h5>
                <p>${species.humanLearning}</p>
            </div>` : ''}
            ${species.conservation ? `
            <div class="advanced-card conservation">
                <h5>üåç Conservation Insights</h5>
                <p>${species.conservation}</p>
            </div>` : ''}
        </div>
    </div>` : ''}

    ${species.sources && species.sources.length > 0 ? `
    <div class="sources">
        <h5>üìö Research Sources</h5>
        <ul>
            ${species.sources.map(source => `<li>${source}</li>`).join('')}
        </ul>
    </div>` : ''}`;
            });

            // Add special sections if they exist
            if (researchResults.special) {
                htmlContent += `
    <div class="special-sections">
        <div class="section-title">Unified Intelligence Insights</div>
        
        <div class="special-card">
            <h3>‚ö° Unified Physics Integration</h3>
            <p>${researchResults.special.unified_physics}</p>
        </div>
        
        <div class="special-card">
            <h3>üå± Contribution to Life</h3>
            <p>${researchResults.special.contribution_to_life}</p>
        </div>
        
        <div class="special-card">
            <h3>üî¨ Research Frontiers</h3>
            <p>${researchResults.special.research_frontiers}</p>
        </div>
    </div>`;
            }

            htmlContent += `
    <div class="footer">
        <p><strong>Generated by Unspeciated: Redefining Intelligence Research Platform</strong></p>
        <p>Secure Firebase Functions ‚Ä¢ Intuitive Learning Foundation ‚Ä¢ kerrilake.com</p>
        <p>Framework for redefining intelligence beyond human-centric definitions</p>
        <p>¬© 2025 Kerri Lake. Research supporting collaborative intelligence across all life forms.</p>
    </div>
</body>
</html>`;

            // Open in new window and trigger print dialog for PDF generation
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Wait a moment for content to load, then trigger print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                
                // Optional: Close the window after printing (some browsers may block this)
                printWindow.addEventListener('afterprint', () => {
                    printWindow.close();
                });
            }, 500);
        }

        window.openContributeForm = function() {
            alert('Contribute Knowledge feature coming soon! This will allow researchers worldwide to add their intelligence discoveries to our shared database.');
        };
    </script>
</body>
</html>
